<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatAI — Demo</title>
  <meta name="description" content="Demo chat UI dengan tema gelap/terang, obrolan baru, dan settings API key (local testing only)" />

  <style>
    :root{
      --bg: #f6f7fb;
      --panel: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent: #4f46e5;
      --user-bg: #4f46e5;
      --assistant-bg: #e6eefb;
      --border: #e6e9ef;
    }
    .dark{
      --bg: #0b1220;
      --panel: #071029;
      --text: #e6eef5;
      --muted: #9aa8b6;
      --accent: #7c5cff;
      --user-bg: #7c5cff;
      --assistant-bg: #0f1724;
      --border: #122033;
    }

    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,var(--bg), #e9eef9 80%); color:var(--text);}

    .app {display:flex; height:100vh; gap:1rem; padding:1rem; box-sizing:border-box;}
    .sidebar {width:300px; background:var(--panel); border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.04);}
    .main {flex:1; display:flex; flex-direction:column; border-radius:10px; overflow:hidden; border:1px solid var(--border); background:var(--panel);}

    /* Sidebar header */
    .sb-head {padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid var(--border);}
    .brand {font-weight:700; font-size:18px; letter-spacing:0.2px;}
    .muted {color:var(--muted); font-size:13px;}

    .sb-actions {display:flex; gap:8px;}
    .btn {padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:transparent; cursor:pointer; font-size:13px;}
    .btn.primary {background:var(--accent); color:white; border:none;}
    .btn.ghost {background:transparent;border:1px dashed var(--border);}

    .conv-list {padding:10px; overflow:auto; flex:1;}
    .conv-item {padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; cursor:pointer;}
    .conv-item:hover {background:linear-gradient(90deg, rgba(0,0,0,0.02), transparent);}
    .conv-item.active {background:var(--accent); color:white;}
    .conv-meta{display:flex; flex-direction:column; gap:4px; min-width:0;}
    .conv-title {font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .conv-time{font-size:12px; color:var(--muted);}

    .sb-foot {padding:10px; border-top:1px solid var(--border); font-size:12px; color:var(--muted);}

    /* Main header */
    .main-head {display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border);}
    .main-title {font-weight:700; font-size:16px;}
    .status {font-size:13px; color:var(--muted);}

    /* Chat area */
    .chat-area {flex:1; padding:18px; overflow:auto; display:flex; flex-direction:column; gap:12px; align-items:stretch;}
    .bubble {max-width:75%; padding:12px 14px; border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,0.02); white-space:pre-wrap; line-height:1.45;}
    .bubble.user {margin-left:auto; background:var(--user-bg); color:white; border-bottom-right-radius:4px;}
    .bubble.assistant {margin-right:auto; background:var(--assistant-bg); color:var(--text); border-bottom-left-radius:4px;}
    .bubble .role {display:block; font-size:11px; color:var(--muted); margin-top:8px;}

    /* Composer */
    .composer {padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; align-items:flex-end;}
    .input {flex:1; min-height:48px; max-height:200px; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); resize:none; font-size:14px; outline:none;}
    .compose-actions {display:flex; gap:8px;}
    .small {padding:8px 10px; font-size:13px;}

    /* modal */
    .modal-back {position:fixed; inset:0; background:rgba(2,6,23,0.5); display:flex; align-items:center; justify-content:center; z-index:50;}
    .modal {width:520px; max-width:95%; background:var(--panel); border-radius:10px; padding:16px; border:1px solid var(--border); box-shadow:0 12px 40px rgba(2,6,23,0.25);}
    .modal h3 {margin:0 0 8px 0;}
    .modal .row {display:flex; gap:8px; align-items:center; margin-bottom:8px;}
    .modal input[type="password"], .modal input[type="text"] {flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); font-size:14px; background:transparent; color:var(--text);}

    /* small utilities */
    .muted-small {font-size:12px; color:var(--muted);}
    .tiny {font-size:12px;}
    .flex {display:flex;}
    .hidden {display:none;}
    @media (max-width:900px){
      .sidebar{width:64px;}
      .conv-title{display:none;}
      .sb-head .brand{display:none;}
    }
  </style>
</head>
<body>
  <div id="app" class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Sidebar">
      <div class="sb-head">
        <div>
          <div class="brand">ChatAI</div>
          <div class="muted tiny">Demo lokal • jangan pakai kunci publik</div>
        </div>
        <div class="sb-actions">
          <button id="themeToggle" class="btn" title="Toggle theme">Gelap</button>
          <button id="openSettings" class="btn">Settings</button>
        </div>
      </div>

      <div style="padding:10px; display:flex; gap:8px;">
        <button id="newConv" class="btn primary" title="Buat obrolan baru">Obrolan Baru</button>
        <button id="importBtn" class="btn ghost" title="Import/Restore">Restore</button>
      </div>

      <div class="conv-list" id="convList" role="list">
        <!-- conversations rendered here -->
      </div>

      <div class="sb-foot">
        <div class="muted-small">Tip: Simpan API key di Settings hanya untuk tes lokal. Jika kunci bocor, segera revoke.</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main" role="main">
      <div class="main-head">
        <div>
          <div class="main-title" id="mainTitle">Pilih obrolan atau buat obrolan baru</div>
          <div class="muted tiny" id="convMeta">—</div>
        </div>
        <div class="status" id="status">Siap</div>
      </div>

      <section class="chat-area" id="chatArea" aria-live="polite">
        <div class="muted-small" id="emptyHint" style="margin:auto; text-align:center; width:100%;">Tidak ada pesan. Klik <strong>Obrolan Baru</strong> untuk mulai.</div>
      </section>

      <div class="composer">
        <textarea id="messageInput" class="input" placeholder="Ketik pesan... (enter untuk baris baru, Ctrl+Enter untuk kirim)"></textarea>
        <div class="compose-actions">
          <button id="sendBtn" class="btn primary" title="Kirim">Kirim</button>
          <button id="exportBtn" class="btn" title="Export percakapan">Export</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="modal" class="modal-back hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal" role="document">
      <h3 id="modalTitle">Pengaturan</h3>
      <div class="row">
        <label class="tiny" style="min-width:80px;">OpenAI Key</label>
        <input id="apiKeyInput" type="password" placeholder="Masukkan API key untuk tes lokal (tidak direkomendasikan di public PC)">
      </div>
      <div class="row">
        <label class="tiny" style="min-width:80px;">Model</label>
        <input id="modelInput" type="text" value="gpt-4o-mini" />
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
        <button id="closeModal" class="btn">Tutup</button>
        <button id="saveSettings" class="btn primary">Simpan</button>
      </div>

      <hr style="margin:10px 0;border:none;border-top:1px solid var(--border)" />
      <div class="muted-small">Keamanan: Simpan kunci di perangkat Anda sendiri. Untuk aplikasi publik, pakai server proxy. Jangan membagikan kunci di chat publik.</div>
    </div>
  </div>

  <script>
    // Simple chat UI logic using localStorage
    (function(){
      const root = document.documentElement;
      const APP_KEY = 'chatai_demo_v1';
      const THEME_KEY = 'chatai_demo_theme';
      const API_KEY = 'chatai_demo_apikey';
      const MODEL_KEY = 'chatai_demo_model';

      const convListEl = document.getElementById('convList');
      const chatArea = document.getElementById('chatArea');
      const newConvBtn = document.getElementById('newConv');
      const sendBtn = document.getElementById('sendBtn');
      const exportBtn = document.getElementById('exportBtn');
      const messageInput = document.getElementById('messageInput');
      const emptyHint = document.getElementById('emptyHint');
      const mainTitle = document.getElementById('mainTitle');
      const convMeta = document.getElementById('convMeta');
      const statusEl = document.getElementById('status');

      const themeToggle = document.getElementById('themeToggle');
      const modal = document.getElementById('modal');
      const openSettings = document.getElementById('openSettings');
      const closeModal = document.getElementById('closeModal');
      const saveSettings = document.getElementById('saveSettings');
      const apiKeyInput = document.getElementById('apiKeyInput');
      const modelInput = document.getElementById('modelInput');

      let state = {
        conversations: [], // {id, title, createdAt, messages:[{role,content,time}]}
        activeId: null,
        isThinking: false
      };

      // init
      function load() {
        const s = localStorage.getItem(APP_KEY);
        state = s ? JSON.parse(s) : state;
        const theme = localStorage.getItem(THEME_KEY) || 'dark';
        applyTheme(theme);
        const savedApi = localStorage.getItem(API_KEY) || '';
        apiKeyInput.value = savedApi;
        const savedModel = localStorage.getItem(MODEL_KEY) || 'gpt-4o-mini';
        modelInput.value = savedModel;
        render();
      }

      function save() {
        localStorage.setItem(APP_KEY, JSON.stringify(state));
      }

      function applyTheme(t) {
        if (t === 'dark') {
          document.body.classList.add('dark');
          themeToggle.textContent = 'Terang';
        } else {
          document.body.classList.remove('dark');
          themeToggle.textContent = 'Gelap';
        }
        localStorage.setItem(THEME_KEY, t);
      }

      themeToggle.addEventListener('click', () => {
        const cur = document.body.classList.contains('dark') ? 'dark' : 'light';
        applyTheme(cur === 'dark' ? 'light' : 'dark');
      });

      openSettings.addEventListener('click', () => modal.classList.remove('hidden'));
      closeModal.addEventListener('click', () => modal.classList.add('hidden'));
      saveSettings.addEventListener('click', () => {
        localStorage.setItem(API_KEY, apiKeyInput.value.trim());
        localStorage.setItem(MODEL_KEY, modelInput.value.trim() || 'gpt-4o-mini');
        alert('Disimpan (lokal). Untuk produksi pakai server proxy.');
        modal.classList.add('hidden');
      });

      newConvBtn.addEventListener('click', () => {
        const id = Date.now().toString();
        const conv = {
          id,
          title: 'Obrolan baru',
          createdAt: new Date().toISOString(),
          messages: [{role:'system', content: 'Kamu adalah asisten yang membantu dengan jelas dan singkat.', time: Date.now()}]
        };
        state.conversations.unshift(conv);
        state.activeId = id;
        save();
        render();
        focusInput();
      });

      function focusInput(){ messageInput.focus(); }

      convListEl.addEventListener('click', (ev) => {
        const item = ev.target.closest('.conv-item');
        if (!item) return;
        const id = item.dataset.id;
        if (ev.target.matches('.delete-btn')) {
          // delete
          state.conversations = state.conversations.filter(c => c.id !== id);
          if (state.activeId === id) state.activeId = state.conversations[0]?.id || null;
          save(); render();
          return;
        }
        if (ev.target.matches('.export-btn')) {
          const conv = state.conversations.find(c => c.id === id);
          if (conv) exportConv(conv);
          return;
        }
        state.activeId = id;
        render();
      });

      function render() {
        renderConvList();
        renderActive();
      }

      function renderConvList(){
        convListEl.innerHTML = '';
        if (state.conversations.length === 0) {
          convListEl.innerHTML = '<div class="muted-small" style="padding:12px">Belum ada obrolan.</div>';
          return;
        }
        for (const c of state.conversations) {
          const active = c.id === state.activeId;
          const wrapper = document.createElement('div');
          wrapper.className = 'conv-item' + (active? ' active':'');
          wrapper.dataset.id = c.id;
          wrapper.innerHTML = `
            <div class="conv-meta">
              <div class="conv-title">${escapeHtml(c.title || 'Obrolan')}</div>
              <div class="conv-time">${new Date(c.createdAt).toLocaleString()}</div>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <button class="btn export-btn tiny" title="Export">Export</button>
              <button class="btn delete-btn tiny" title="Hapus">Hapus</button>
            </div>
          `;
          convListEl.appendChild(wrapper);
        }
      }

      function renderActive() {
        const conv = state.conversations.find(c => c.id === state.activeId);
        chatArea.innerHTML = '';
        if (!conv) {
          emptyHint.style.display = 'block';
          mainTitle.textContent = 'Pilih obrolan atau buat obrolan baru';
          convMeta.textContent = '—';
          return;
        }
        emptyHint.style.display = 'none';
        mainTitle.textContent = conv.title || 'Obrolan';
        convMeta.textContent = `${conv.messages.length} pesan • dibuat ${new Date(conv.createdAt).toLocaleString()}`;

        conv.messages.forEach(m => {
          const b = document.createElement('div');
          b.className = 'bubble ' + (m.role === 'user' ? 'user' : 'assistant');
          b.innerHTML = `<div class="content">${escapeHtml(m.content)}</div><div class="role">${m.role} • ${new Date(m.time||0).toLocaleTimeString()}</div>`;
          chatArea.appendChild(b);
        });

        // auto scroll to bottom
        setTimeout(()=>{ chatArea.scrollTop = chatArea.scrollHeight; }, 30);
      }

      sendBtn.addEventListener('click', sendHandler);
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) { // ctrl+enter to send
          sendHandler();
        }
      });

      function sendHandler(){
        const txt = messageInput.value.trim();
        if (!txt) return;
        if (!state.activeId) {
          // create new conv
          newConvBtn.click();
          // small timeout then send
          setTimeout(()=>sendHandler(), 60);
          return;
        }
        const conv = state.conversations.find(c => c.id === state.activeId);
        conv.messages.push({role:'user', content: txt, time: Date.now()});
        save();
        messageInput.value = '';
        renderActive();
        // call API scaffold
        callOpenAI(conv).catch(e => {
          conv.messages.push({role:'assistant', content: 'Error: '+e.message, time: Date.now()});
          save(); renderActive();
        });
      }

      async function callOpenAI(conv) {
        const apiKey = localStorage.getItem(API_KEY) || '';
        const model = localStorage.getItem(MODEL_KEY) || modelInput.value || 'gpt-4o-mini';

        if (!apiKey) {
          conv.messages.push({role:'assistant', content: 'Tidak ada API key tersimpan. Buka Settings untuk menambahkan (lokal).', time: Date.now()});
          save(); renderActive();
          return;
        }

        statusEl.textContent = 'Membalas...';
        try {
          // build messages payload
          const messages = conv.messages.filter(m => m.role !== 'system' || true).map(m => ({role: m.role, content: m.content}));
          // Note: direct client-side calls expose the API key. Use server proxy for production.
          const resp = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
              model,
              messages,
              max_tokens: 800,
            })
          });

          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('API error: ' + resp.status + ' ' + txt);
          }
          const data = await resp.json();
          const assistant = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text || '(No response)';
          conv.messages.push({role:'assistant', content: assistant, time: Date.now()});
          save(); renderActive();
        } finally {
          statusEl.textContent = 'Siap';
        }
      }

      function exportConv(conv) {
        const content = conv.messages.map(m => `${m.role.toUpperCase()} (${new Date(m.time||0).toLocaleString()}):\n${m.content}`).join('\n\n');
        const blob = new Blob([content], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (conv.title || 'conversation') + '.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      exportBtn.addEventListener('click', () => {
        const conv = state.conversations.find(c => c.id === state.activeId);
        if (!conv) { alert('Pilih obrolan dulu.'); return; }
        exportConv(conv);
      });

      // import / restore (simple)
      document.getElementById('importBtn').addEventListener('click', () => {
        const raw = prompt('Tempel JSON obrolan untuk restore (format internal).');
        if (!raw) return;
        try {
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) throw new Error('Format salah, harus array conversations.');
          state.conversations = parsed.concat(state.conversations);
          state.activeId = state.conversations[0]?.id || null;
          save(); render();
          alert('Restore selesai.');
        } catch (e) { alert('Error: '+e.message); }
      });

      // util
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

      // initial load
      load();

      // keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          messageInput.focus();
        }
        if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          newConvBtn.click();
        }
      });

      // accessibility: close modal on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.add('hidden');
      });

    })();
  </script>
</body>
</html>
